<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family | Robins blog</title><meta name=keywords content="rust,embedded,space,va10820"><meta name=description content="The last few weeks I have been busy diving into the Rust ecosystem and learning the language through practical projects. I finishing the excellent Rust book and the Rust Embedded Book first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical projects to further learn the language. I&rsquo;ve tried to combine this with the usual activities at the research institute I work now as well."><meta name=author content><link rel=canonical href=https://robamu.github.io/posts/rust-ecosystem/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://robamu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://robamu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://robamu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://robamu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://robamu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family"><meta property="og:description" content="The last few weeks I have been busy diving into the Rust ecosystem and learning the language through practical projects. I finishing the excellent Rust book and the Rust Embedded Book first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical projects to further learn the language. I&rsquo;ve tried to combine this with the usual activities at the research institute I work now as well."><meta property="og:type" content="article"><meta property="og:url" content="https://robamu.github.io/posts/rust-ecosystem/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-15T23:31:00+01:00"><meta property="article:modified_time" content="2023-09-04T16:35:05+02:00"><meta property="og:site_name" content="robs blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family"><meta name=twitter:description content="The last few weeks I have been busy diving into the Rust ecosystem and learning the language through practical projects. I finishing the excellent Rust book and the Rust Embedded Book first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical projects to further learn the language. I&rsquo;ve tried to combine this with the usual activities at the research institute I work now as well."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://robamu.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family","item":"https://robamu.github.io/posts/rust-ecosystem/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family","name":"Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family","description":"The last few weeks I have been busy diving into the Rust ecosystem and learning the language through practical projects. I finishing the excellent Rust book and the Rust Embedded Book first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical projects to further learn the language. I\u0026rsquo;ve tried to combine this with the usual activities at the research institute I work now as well.","keywords":["rust","embedded","space","va10820"],"articleBody":"The last few weeks I have been busy diving into the Rust ecosystem and learning the language through practical projects. I finishing the excellent Rust book and the Rust Embedded Book first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical projects to further learn the language. I’ve tried to combine this with the usual activities at the research institute I work now as well.\nWorking at an insitute which builds small satellites gives me access to unique hardware like the radiation hardened Vorago MCUs which are usually not used by hobbyist because of their price tag. 3-4 digits are very common even for basic radiation hardened components. Some of these MCUs are used in our CubeSat projects and I was curious whether I could set up Rust for some of the MCUs, namely the VA10820 Cortex-M0 based MCU. Vorago sells some of their chips on a Vorago development board named REB1 and I was able to get my hands on one.\nBrowsing the internet a bit, I quickly found out that nobody attempted to create supporting libraries for these MCUs yet. I thought this was an excellent opportunity to learn a lot of aspects of Embedded Rust. The Rust book had an excellent picture of what a ecosystem for a particular MCU family or board might look like\nEmbedded Rust Abstraction Layers\nI started with the lowest necessary level to build higher level abstractions: The Peripheral Access Crate (PAC). After a few tweaks to the vendor supplied SVD file and the svd2rust tool, I was able to generate my first own PAC.\nI then set up the blinky application as the classical first application for a new MCU to test my PAC. This is what it looks like\n#![no_main] #![no_std] use cortex_m_rt::entry; use panic_halt as _; use va108xx as pac; // REB LED pin definitions. All on port A const LED_D2: u32 = 1 \u003c\u003c 10; const LED_D3: u32 = 1 \u003c\u003c 7; const LED_D4: u32 = 1 \u003c\u003c 6; #[entry] fn main() -\u003e ! { let dp = pac::Peripherals::take().unwrap(); // Enable all peripheral clocks dp.SYSCONFIG .peripheral_clk_enable .modify(|_, w| unsafe { w.bits(0xffffffff) }); dp.PORTA .dir() .modify(|_, w| unsafe { w.bits(LED_D2 | LED_D3 | LED_D4) }); dp.PORTA .datamask() .modify(|_, w| unsafe { w.bits(LED_D2 | LED_D3 | LED_D4) }); for _ in 0..10 { dp.PORTA .clrout() .write(|w| unsafe { w.bits(LED_D2 | LED_D3 | LED_D4) }); cortex_m::asm::delay(5_000_000); dp.PORTA .setout() .write(|w| unsafe { w.bits(LED_D2 | LED_D3 | LED_D4) }); cortex_m::asm::delay(5_000_000); } loop { dp.PORTA .togout() .write(|w| unsafe { w.bits(LED_D2 | LED_D3 | LED_D4) }); cortex_m::asm::delay(25_000_000); } } With the JLink tools installed and a few helper files in place you can find in my workspace, I started the JLinkGDBServer and then flashed the board with\ncargo run -p va108xx-hal --example blinky-pac Blinky in action\nLooking good!\nNow, the next challenge was to write the next level of abstraction: A Hardware Abstraction Layer (HAL) crate. I started browsing some of the HALs like the stm32f1xx-hal and intially felt overwhelmed by all the new syntax, macros and ways to write Rust code I have not seen before. But I also thought that implementing this for a new MCU family would be an excellent way to learn a lot.\nYou can find the first version I eventually was able to hack together here. The most challenging task was to wrap around my head around the typesystem and the macro system. Since then, I refactored the GPIO library to use even more type-level features based on the excellent atsamd HAL.\nThe blinky example using the hardware abstraction layer looks like this\n#![no_main] #![no_std] use cortex_m_rt::entry; use embedded_hal::digital::v2::ToggleableOutputPin; use panic_halt as _; use va108xx_hal::{gpio::PinsA, pac, prelude::*}; #[entry] fn main() -\u003e ! { let mut dp = pac::Peripherals::take().unwrap(); let porta = PinsA::new(\u0026mut dp.SYSCONFIG, Some(dp.IOCONFIG), dp.PORTA); let mut led1 = porta.pa10.into_push_pull_output(); let mut led2 = porta.pa7.into_push_pull_output(); let mut led3 = porta.pa6.into_push_pull_output(); for _ in 0..10 { led1.set_low().ok(); led2.set_low().ok(); led3.set_low().ok(); cortex_m::asm::delay(5_000_000); led1.set_high().ok(); led2.set_high().ok(); led3.set_high().ok(); cortex_m::asm::delay(5_000_000); } loop { led1.toggle().ok(); cortex_m::asm::delay(5_000_000); led2.toggle().ok(); cortex_m::asm::delay(5_000_000); led3.toggle().ok(); cortex_m::asm::delay(5_000_000); } } A lot more readble and neat that the low level PAC version.\nEquipped with a lot more knowledge, I implemented a HAL for all other peripherals, using what I saw in different HALs like the ATSAMD HAL or the STM32 HALs. Writing the basic blocking API was mostly straighforward once I got more familiar with writing HAL code. I still have to write code which is able to use interrupts to efficiently clear the various FIFOs. Using these FIFOs reduces CPU load is the only sensible for peripherals like the UART to efficiently receive all arriving RX data.\nAs a final step, I also implemented a Board Support Package targeted towards the REB1 development board. This also was an excellent way for me to test the I2C implementation because that board was equiped with a simple ADT75 I2C temperature sensor device.\nThe example application looks like this now\n#![no_main] #![no_std] use cortex_m_rt::entry; use panic_rtt_target as _; use rtt_target::{rprintln, rtt_init_print}; use va108xx_hal::{ pac::{self, interrupt}, prelude::*, timer::{default_ms_irq_handler, set_up_ms_timer, Delay}, }; use vorago_reb1::temp_sensor::Adt75TempSensor; #[entry] fn main() -\u003e ! { rtt_init_print!(); rprintln!(\"-- Vorago Temperature Sensor and I2C Example --\"); let mut dp = pac::Peripherals::take().unwrap(); let tim0 = set_up_ms_timer( \u0026mut dp.SYSCONFIG, \u0026mut dp.IRQSEL, 50.mhz().into(), dp.TIM0, interrupt::OC0, ); let mut delay = Delay::new(tim0); unsafe { cortex_m::peripheral::NVIC::unmask(pac::Interrupt::OC0); } let mut temp_sensor = Adt75TempSensor::new(dp.I2CA, 50.mhz(), Some(\u0026mut dp.SYSCONFIG)) .expect(\"Creating temperature sensor struct failed\"); loop { let temp = temp_sensor .read_temperature() .expect(\"Failed reading temperature\"); rprintln!(\"Temperature in Celcius: {}\", temp); delay.delay_ms(500); } } #[interrupt] fn OC0() { default_ms_irq_handler(); } In my opinion, all the abstractions made this code really neat a brief. In this example, one can also see a few more features being used:\nThe RTT logger, which worked more or less out of the box. Really useful to get debugging output An interrupt being used to get a MS timer tick. The Cortex-M0 does not really have a SysTick peripheral suitable for this task, but the 24 TIM peripherals can be set up to generate millisecond or second interrupts without issues. For something common like a millisecond counter, I set up default setup functions and IRQ handlers like seen in the code above. A temperature sensor abstraction provided by the BSP, which makes this example application really concise. And this is what the output looks like after flashing the board with\ncargo run --example adt75-temp-sensor Reading a temperature sensor in Rust\nI would also like to write a bit about the development workflow I am using. It is possible doing debugging using a graphical user interface which is important for any application which is more complex in my opinion. I am using VS code for this and I’m really happy with the development workflow. All that is required is the Cortex-Debug plugin.\nAn example launch.json file for VS code looks like this\n{ \"version\": \"0.2.0\", \"configurations\": [ { \"type\": \"cortex-debug\", \"request\": \"launch\", \"name\": \"Debug Blinky\", \"servertype\": \"jlink\", \"cwd\": \"${workspaceRoot}\", \"device\": \"VA10820\", \"svdFile\": \"../va108xx-rs/va108xx.svd\", \"preLaunchTask\": \"rust: cargo build minimal blinky\", \"executable\": \"${workspaceFolder}/target/thumbv6m-none-eabi/debug/examples/blinky-leds\", \"interface\": \"jtag\", \"runToMain\": true, }, ] } and an example tasks.json file like this\n{ \"version\": \"2.0.0\", \"tasks\": [ { \"label\": \"rust: cargo build blinky\", \"type\": \"shell\", \"command\": \"~/.cargo/bin/cargo\", // note: full path to the cargo \"args\": [ \"build\", \"--example\", \"blinky-leds\", ], \"group\": { \"kind\": \"build\", \"isDefault\": true } }, ] } with this, we can soon use the Run \u0026 Debug tab of VS code to debug our applications\nDebugging with VS Code\nImplementing a full Rust ecosystem for the VA10820 has been a challenging but satisfying task. I think Rust offers excellent features which are really useful to write safe code for space applications and I hope that some of the code I have written will be used to run awesome missions soon.\nIn the meantime, I also managed to procure a PEB1 development board for the VA416xx familyof devices. I also want to thank Thales Alenia Space for providing me with this expensive hardware. I am also trying to get the industry version of the SAMRH71 MCU. Time to write more Rust code!\n","wordCount":"1342","inLanguage":"en","datePublished":"2021-12-15T23:31:00+01:00","dateModified":"2023-09-04T16:35:05+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://robamu.github.io/posts/rust-ecosystem/"},"publisher":{"@type":"Organization","name":"Robins blog","logo":{"@type":"ImageObject","url":"https://robamu.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://robamu.github.io accesskey=h title="Robins blog (Alt + H)">Robins blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://robamu.github.io title=Home><span>Home</span></a></li><li><a href=https://robamu.github.io/about title=About><span>About</span></a></li><li><a href=https://robamu.github.io/contact title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Bringing Rust to Space - Setting up a Rust ecosystem for the VA108XX MCU family</h1><div class=post-meta><span title='2021-12-15 23:31:00 +0100 +0100'>December 15, 2021</span></div></header><div class=post-content><p>The last few weeks I have been busy diving into the Rust ecosystem and learning the language
through practical projects. I finishing the excellent
<a href=https://doc.rust-lang.org/book/>Rust book</a> and the <a href=https://docs.rust-embedded.org/book/>Rust Embedded Book</a>
first and then tinkered with Rust on some STM32 MCUs. As a next step, I was looking for practical
projects to further learn the language. I&rsquo;ve tried to combine this with the usual activities at
the research institute I work now as well.</p><p>Working at an insitute which builds small satellites gives me access to unique hardware like
the radiation hardened Vorago MCUs which are usually not used by hobbyist because of their
price tag. 3-4 digits are very common even for basic radiation hardened components.
Some of these MCUs are used in our CubeSat projects and I was
curious whether I could set up Rust for some of the MCUs, namely the VA10820 Cortex-M0 based MCU.
Vorago sells some of their chips on a Vorago development board named REB1 and I was able to get my
hands on one.</p><p>Browsing the internet a bit, I quickly found out that nobody attempted to create supporting
libraries for these MCUs yet. I thought this was an excellent opportunity to learn a lot of
aspects of Embedded Rust. The Rust book had an excellent picture of what a ecosystem for a particular
MCU family or board might look like</p><center><figure><img loading=lazy src=/img/rust-ecosystem/crates.png alt="Embedded Rust Abstraction Layers"><figcaption><p>Embedded Rust Abstraction Layers</p></figcaption></figure></center><p>I started with the lowest necessary level to build higher level abstractions:
The Peripheral Access Crate (PAC). After a few tweaks to the vendor supplied SVD file and the
<code>svd2rust</code> tool, I was able to generate my first own PAC.</p><p>I then set up the blinky application as the classical first application for a new MCU to test
my PAC. This is what it looks like</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=cp>#![no_main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![no_std]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>cortex_m_rt</span>::<span class=n>entry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>panic_halt</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>_</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>va108xx</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>pac</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// REB LED pin definitions. All on port A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span><span class=w> </span><span class=no>LED_D2</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>LED_D3</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>LED_D4</span>: <span class=kt>u32</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[entry]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>dp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pac</span>::<span class=n>Peripherals</span>::<span class=n>take</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Enable all peripheral clocks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>dp</span><span class=p>.</span><span class=no>SYSCONFIG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>peripheral_clk_enable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>modify</span><span class=p>(</span><span class=o>|</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=mh>0xffffffff</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>dir</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>modify</span><span class=p>(</span><span class=o>|</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=no>LED_D2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D4</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>datamask</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>modify</span><span class=p>(</span><span class=o>|</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=no>LED_D2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D4</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>10</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>clrout</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=o>|</span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=no>LED_D2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D4</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>setout</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=o>|</span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=no>LED_D2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D4</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>togout</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=o>|</span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>w</span><span class=p>.</span><span class=n>bits</span><span class=p>(</span><span class=no>LED_D2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=no>LED_D4</span><span class=p>)</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>25_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>With the JLink tools installed and a few helper files in place you can find in my
<a href=https://egit.irs.uni-stuttgart.de/rust/va108xx-workspace>workspace</a>, I started the <code>JLinkGDBServer</code>
and then flashed the board with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo run -p va108xx-hal --example blinky-pac
</span></span></code></pre></div><center><figure><img loading=lazy src=/gif/rust-ecosystem/vor-blinky.gif alt="Blinky GIF"><figcaption><p>Blinky in action</p></figcaption></figure></center><p>Looking good!</p><p>Now, the next challenge was to write the next level of abstraction: A Hardware Abstraction
Layer (HAL) crate. I started browsing some of the HALs like the
<a href=https://github.com/stm32-rs/stm32f1xx-hal/blob/master/src/gpio.rs>stm32f1xx-hal</a> and intially
felt overwhelmed by all the new syntax, macros and ways to write Rust code I have not seen before.
But I also thought that implementing this for a new MCU family would be an excellent way to learn
a lot.</p><p>You can find the first version I eventually was able to hack together
<a href=https://github.com/robamu-org/va108xx-hal-rs/blob/v0.1.0/src/gpio.rs>here</a>.
The most challenging task was to wrap around my head around the typesystem and the macro system.
Since then, I refactored the GPIO library to use even more type-level features based on the
excellent <a href=https://docs.rs/atsamd-hal/latest/atsamd_hal/gpio/v2/index.html>atsamd HAL</a>.</p><p>The blinky example using the hardware abstraction layer looks like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=cp>#![no_main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![no_std]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>cortex_m_rt</span>::<span class=n>entry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>embedded_hal</span>::<span class=n>digital</span>::<span class=n>v2</span>::<span class=n>ToggleableOutputPin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>panic_halt</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>_</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>va108xx_hal</span>::<span class=p>{</span><span class=n>gpio</span>::<span class=n>PinsA</span><span class=p>,</span><span class=w> </span><span class=n>pac</span><span class=p>,</span><span class=w> </span><span class=n>prelude</span>::<span class=o>*</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[entry]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pac</span>::<span class=n>Peripherals</span>::<span class=n>take</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>porta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PinsA</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=p>.</span><span class=no>SYSCONFIG</span><span class=p>,</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>dp</span><span class=p>.</span><span class=no>IOCONFIG</span><span class=p>),</span><span class=w> </span><span class=n>dp</span><span class=p>.</span><span class=no>PORTA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>led1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>porta</span><span class=p>.</span><span class=n>pa10</span><span class=p>.</span><span class=n>into_push_pull_output</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>led2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>porta</span><span class=p>.</span><span class=n>pa7</span><span class=p>.</span><span class=n>into_push_pull_output</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>led3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>porta</span><span class=p>.</span><span class=n>pa6</span><span class=p>.</span><span class=n>into_push_pull_output</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>10</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led1</span><span class=p>.</span><span class=n>set_low</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led2</span><span class=p>.</span><span class=n>set_low</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led3</span><span class=p>.</span><span class=n>set_low</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led1</span><span class=p>.</span><span class=n>set_high</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led2</span><span class=p>.</span><span class=n>set_high</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led3</span><span class=p>.</span><span class=n>set_high</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led1</span><span class=p>.</span><span class=n>toggle</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led2</span><span class=p>.</span><span class=n>toggle</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>led3</span><span class=p>.</span><span class=n>toggle</span><span class=p>().</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>asm</span>::<span class=n>delay</span><span class=p>(</span><span class=mi>5_000_000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>A lot more readble and neat that the low level PAC version.</p><p>Equipped with a lot more knowledge, I implemented a HAL for all other peripherals, using
what I saw in different HALs like the ATSAMD HAL or the STM32 HALs. Writing the basic blocking API
was mostly straighforward once I got more familiar with writing HAL code. I still have to
write code which is able to use interrupts to efficiently clear the various FIFOs. Using these FIFOs
reduces CPU load is the only sensible for peripherals like the UART to efficiently receive all
arriving RX data.</p><p>As a final step, I also implemented a Board Support Package targeted towards the REB1 development
board. This also was an excellent way for me to test the I2C implementation because that board
was equiped with a simple ADT75 I2C temperature sensor device.</p><p>The example application looks like this now</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=cp>#![no_main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![no_std]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>cortex_m_rt</span>::<span class=n>entry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>panic_rtt_target</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>_</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rtt_target</span>::<span class=p>{</span><span class=n>rprintln</span><span class=p>,</span><span class=w> </span><span class=n>rtt_init_print</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>va108xx_hal</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pac</span>::<span class=p>{</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>interrupt</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>prelude</span>::<span class=o>*</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timer</span>::<span class=p>{</span><span class=n>default_ms_irq_handler</span><span class=p>,</span><span class=w> </span><span class=n>set_up_ms_timer</span><span class=p>,</span><span class=w> </span><span class=n>Delay</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>vorago_reb1</span>::<span class=n>temp_sensor</span>::<span class=n>Adt75TempSensor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[entry]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>rtt_init_print!</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>rprintln!</span><span class=p>(</span><span class=s>&#34;-- Vorago Temperature Sensor and I2C Example --&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pac</span>::<span class=n>Peripherals</span>::<span class=n>take</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>tim0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>set_up_ms_timer</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=p>.</span><span class=no>SYSCONFIG</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=p>.</span><span class=no>IRQSEL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mf>50.</span><span class=n>mhz</span><span class=p>().</span><span class=n>into</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dp</span><span class=p>.</span><span class=no>TIM0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interrupt</span>::<span class=no>OC0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Delay</span>::<span class=n>new</span><span class=p>(</span><span class=n>tim0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cortex_m</span>::<span class=n>peripheral</span>::<span class=no>NVIC</span>::<span class=n>unmask</span><span class=p>(</span><span class=n>pac</span>::<span class=n>Interrupt</span>::<span class=no>OC0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>temp_sensor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Adt75TempSensor</span>::<span class=n>new</span><span class=p>(</span><span class=n>dp</span><span class=p>.</span><span class=no>I2CA</span><span class=p>,</span><span class=w> </span><span class=mf>50.</span><span class=n>mhz</span><span class=p>(),</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>dp</span><span class=p>.</span><span class=no>SYSCONFIG</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Creating temperature sensor struct failed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>temp_sensor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>read_temperature</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Failed reading temperature&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>rprintln!</span><span class=p>(</span><span class=s>&#34;Temperature in Celcius: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>temp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>delay</span><span class=p>.</span><span class=n>delay_ms</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[interrupt]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>OC0</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>default_ms_irq_handler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>In my opinion, all the abstractions made this code really neat a brief. In this example, one
can also see a few more features being used:</p><ol><li>The RTT logger, which worked more or less out of the box. Really useful to get debugging output</li><li>An interrupt being used to get a MS timer tick. The Cortex-M0 does not really have
a SysTick peripheral suitable for this task, but the 24 TIM peripherals can be set up to generate
millisecond or second interrupts without issues. For something common like a millisecond counter,
I set up default setup functions and IRQ handlers like seen in the code above.</li><li>A temperature sensor abstraction provided by the BSP, which makes this example application really
concise.</li></ol><p>And this is what the output looks like after flashing the board with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=n>cargo</span><span class=w> </span><span class=n>run</span><span class=w> </span><span class=o>--</span><span class=n>example</span><span class=w> </span><span class=n>adt75</span><span class=o>-</span><span class=n>temp</span><span class=o>-</span><span class=n>sensor</span><span class=w>
</span></span></span></code></pre></div><center><figure><img loading=lazy src=/img/rust-ecosystem/temp-sensor.png alt="Reading a temperature sensor in Rust"><figcaption><p>Reading a temperature sensor in Rust</p></figcaption></figure></center><p>I would also like to write a bit about the development workflow I am using. It is possible doing
debugging using a graphical user interface which is important for any application which is more
complex in my opinion. I am using VS code for this and I&rsquo;m really happy with the development
workflow. All that is required is the <code>Cortex-Debug</code> plugin.</p><p>An example <code>launch.json</code> file for VS code looks like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;configurations&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;cortex-debug&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;request&#34;</span><span class=p>:</span> <span class=s2>&#34;launch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Debug Blinky&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;servertype&#34;</span><span class=p>:</span> <span class=s2>&#34;jlink&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;cwd&#34;</span><span class=p>:</span> <span class=s2>&#34;${workspaceRoot}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=s2>&#34;VA10820&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;svdFile&#34;</span><span class=p>:</span> <span class=s2>&#34;../va108xx-rs/va108xx.svd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;preLaunchTask&#34;</span><span class=p>:</span> <span class=s2>&#34;rust: cargo build minimal blinky&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;executable&#34;</span><span class=p>:</span> <span class=s2>&#34;${workspaceFolder}/target/thumbv6m-none-eabi/debug/examples/blinky-leds&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;interface&#34;</span><span class=p>:</span> <span class=s2>&#34;jtag&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;runToMain&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>and an example <code>tasks.json</code> file like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tasks&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;rust: cargo build blinky&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;~/.cargo/bin/cargo&#34;</span><span class=p>,</span> <span class=c1>// note: full path to the cargo
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nt>&#34;args&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;build&#34;</span><span class=p>,</span> <span class=s2>&#34;--example&#34;</span><span class=p>,</span> <span class=s2>&#34;blinky-leds&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;build&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;isDefault&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>with this, we can soon use the Run & Debug tab of VS code to debug our applications</p><center><figure><img loading=lazy src=/img/rust-ecosystem/vs-code.png alt="Debugging with VS Code"><figcaption><p>Debugging with VS Code</p></figcaption></figure></center><p>Implementing a full Rust ecosystem for the VA10820 has been a challenging but satisfying task. I
think Rust offers excellent features which are really useful to write safe code for space
applications and I hope that some of the code I have written will be used to run awesome missions
soon.</p><p>In the meantime, I also managed to procure a
<a href=https://www.voragotech.com/products/peb1va416x0-development-kit>PEB1 development board</a> for
the <a href=https://www.voragotech.com/products/va416xx/bga>VA416xx familyof devices</a>. I also want to
thank <a href=https://www.thalesgroup.com/en/global/activities/space>Thales Alenia Space</a> for providing
me with this expensive hardware.
I am also trying to get the industry version of the
<a href=http://ww1.microchip.com/downloads/en/DeviceDoc/00003161A.pdf>SAMRH71</a> MCU. Time to write more
Rust code!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://robamu.github.io/tags/rust/>rust</a></li><li><a href=https://robamu.github.io/tags/embedded/>embedded</a></li><li><a href=https://robamu.github.io/tags/space/>space</a></li><li><a href=https://robamu.github.io/tags/va10820/>va10820</a></li></ul></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-robamu-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://robamu.github.io>Robins blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>